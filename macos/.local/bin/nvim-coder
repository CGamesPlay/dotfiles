#!/bin/bash
# Run nvim in a Coder workspace. Requires direnv installed in the remote
# environment.
set -eu

target=""
nvim_args=()
directory=""
for arg in "$@"; do
	case "$arg" in
		--coder-workspace=*)
			target="${arg#--coder-workspace=}"
			;;
		--coder-dir=*)
			directory="${arg#--coder-dir=}"
			;;
		*)
			nvim_args+=("$arg")
			;;
	esac
done
if ! [ ${target:+1} ]; then
	echo "Must provide --coder-workspace=" >&2
	exit 1
fi
script=(exec direnv exec . nvim ${nvim_args+"${nvim_args[@]}"})
script_str=$(printf '%q ' "${script[@]}")
if [ ${directory:+1} ]; then
	script_str=$(printf 'cd %q && %s' "$directory" "$script_str")
fi
exec ssh "$target.coder" -- sh -c "$(printf '%q' "$script_str")"
