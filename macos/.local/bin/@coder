#!/usr/bin/env bash
# @describe Access Coder workspaces

set -eu

main() { :; }

_choose_workspace() {
	_workspaces | \
		fzf --height "50%" --layout reverse \
			--preview '@coder preview {}' \
			--preview-window=right:60%
}

# @cmd Preview a workspace (for fzf)
# @arg workspace! Workspace to preview
# @meta hidden
preview() {
	# Extract workspace name (middle component: agent.workspace.owner -> workspace)
	local ws_name="${argc_workspace#*.}"
	ws_name="${ws_name%.*}"
	coder show "$ws_name" 2>&1 || echo "Workspace not found or stopped"
}

# @cmd Open SSH in a Coder workspace
# @arg workspace[?`_workspaces`] Workspace to open
# @arg rest~                     Arguments passed to ssh
# @meta default-subcommand
ssh() {
	if [[ -z "${argc_workspace:-}" ]]; then
		argc_workspace=$(_choose_workspace) || exit 0
		echo "$ @coder ssh $argc_workspace"
	fi
	exec command ssh "${argc_workspace}.coder" ${argc_rest+-- "${argc_rest[@]}"}
}

# @cmd Open Neovide in a Coder workspace
# @arg workspace![?`_workspaces`] Workspace to open
# @arg directory                  Directory to change to
# @arg rest~                      Arguments passed to nvim
neovide() {
	exec open -na Neovide --args --wsl --neovim-bin=nvim-coder -- \
		--coder-workspace="${argc_workspace:?}" \
		${argc_directory+--coder-dir="$argc_directory"} \
		${argc_rest+"${argc_rest[@]}"}
}

_workspaces() {
	{
		# Current workspaces from coder
		coder list -o json | \
			jq -r '.[] | .owner_name as $owner | .name as $workspace | .latest_build.resources[]?.agents[]?.name | "\(.).\($workspace).\($owner)"'
		# Historical workspaces from fish history (pattern: agent.workspace.owner)
		fish -c 'history search --prefix "@coder "' 2>/dev/null | \
			sed -nE 's/^@coder (ssh |neovide )?([^[:space:]]+\.[^[:space:]]+\.[^[:space:]]+).*/\2/p'
	} | sort -u
}

if ! command -v argc >/dev/null; then
	echo "This command requires argc. Install from https://github.com/sigoden/argc" >&2
	exit 100
fi
eval "$(argc --argc-eval "$0" "$@")"
