#!/usr/bin/env bash
# @describe Install binaries from GitHub releases
# @option   --target=~/.local   Installation target directory
# @flag     -f --force          Force reinstall even if binary exists
# @arg      packages+[?`_choice_package`]  Binary names to install

set -eu
export TMPDIR=${TMPDIR:-/tmp}
export EGET_BIN=$TMPDIR

# Completion function for argc
_choice_package() {
	awk '
		/^# [^@]/ {
			if (doc == "") {
				doc = substr($0, 3)
			} else {
				has_more = 1
			}
		}
		/^[a-zA-Z_][a-zA-Z0-9_-]*\(\)/ {
			if ($0 !~ /^install_/) {
				doc = ""
				has_more = 0
			}
		}
		/^install_[a-zA-Z0-9_-]+\(\)/ {
			name = $0
			sub(/^install_/, "", name)
			sub(/\(\).*$/, "", name)
			if (has_more) doc = doc "..."
			printf "%s\t%s\n", name, doc
			doc = ""
			has_more = 0
		}
	' "$0"
}

# Command runner
install_argc() {
	eget sigoden/argc --to="$BINDIR"
}

# Terminal screen recorder
install_asciinema() {
	eget asciinema/asciinema --to="$BINDIR"
}

# Modern cat/less replacement
install_bat() {
	eget -a "$(musl_tag)" sharkdp/bat --file="*" --all --to=bat

	cp bat/bat "$BINDIR/"
	cp bat/bat.1 "$MANDIR/man1/"
	cp bat/autocomplete/bat.fish "$HOME/.config/fish/completions/"

	rm -rf bat
}

# Binary installer for rust
install_cargo-binstall() {
	eget -a full -a '^sig' cargo-bins/cargo-binstall --to="$BINDIR"
}

# Container debugging swiss army knife
install_cdebug() {
	eget iximiuz/cdebug --to="$BINDIR"
}

# CLI for accessing coder server (client only)
install_coder() {
	# Download the slim build of coder.
	# https://github.com/coder/coder/blob/0c5809726d61c628ecbd359ae47bb85e83700681/.github/workflows/release.yaml#L672
	local version os arch
	version=$(curl -fsSL https://api.github.com/repos/coder/coder/releases/latest | grep '"tag_name"' | sed -E 's/.*"v([^"]+)".*/\1/')
	os=$(uname -s | tr '[:upper:]' '[:lower:]')
	arch=$(uname -m)

	# Map architecture names
	case "$arch" in
		x86_64) arch="amd64" ;;
		aarch64|arm64) arch="arm64" ;;
		armv7l) arch="armv7" ;;
	esac

	# Construct binary name as shown in releases.coder.com
	local binary_name="coder-${os}-${arch}"
	local url="https://releases.coder.com/coder-cli/${version}/${binary_name}"

	# Download binary directly
	curl -fsSL "$url" -o "$BINDIR/coder"
	chmod +x "$BINDIR/coder"
}

# Cocogitto - conventional commits tooling
install_cog() {
	eget -f 'cog' cocogitto/cocogitto --to="$BINDIR"
}

# Git diff output filter
install_delta() {
	eget -a "$(musl_tag)" dandavison/delta --to="$BINDIR"
}

# My dotfile manager
install_dfm() {
	eget CGamesPlay/dfm --to="$BINDIR"
}

# difftastic - structural diffs
install_difft() {
	eget Wilfred/difftastic --to="$BINDIR"
}

# Per-directory environment variables
install_direnv() {
	eget direnv/direnv --to="$BINDIR"

	version=$(direnv --version)
	for page in direnv-fetchurl direnv-stdlib direnv direnv.toml; do
		curl -fsSL "https://github.com/direnv/direnv/raw/v${version}/man/$page.1" -o "$MANDIR/man1/$page.1"
	done
}

# ECS log formatter (replaced by hl)
install_ecslog() {
	eget trentm/go-ecslog -f ecslog --to="$BINDIR"
}

# Modern ls replacement
install_eza() {
	eget -a 'completions' eza-community/eza -f 'eza.fish' --to="$HOME/.config/fish/completions/"
	eget -a 'man' eza-community/eza --file='*' --to=eza

	cp -rv eza/*.1 "$MANDIR/man1/"
	cp -rv eza/*.5 "$MANDIR/man5/"

	rm -rf eza
}

# Modern find replacement
install_fd() {
	eget sharkdp/fd --file="*" --all --to=fd

	cp fd/fd "$BINDIR/"
	cp fd/fd.1 "$MANDIR/man1/"
	cp fd/autocomplete/fd.fish "$HOME/.config/fish/completions/"

	rm -rf fd
}

# Terminal JSON viewer & processor
install_fx() {
	eget antonmedv/fx --to="$BINDIR"
}

# Fuzzy file finder
install_fzf() {
	eget junegunn/fzf --to="$BINDIR"

	fzf_version=$(fzf --version | awk -F '[()]' '{print $2}')
	curl -fsSL "https://github.com/junegunn/fzf/raw/${fzf_version}/man/man1/fzf.1" -o "$MANDIR/man1/fzf.1"
}

# Go version manager
install_g() {
	eget voidint/g --to="$BINDIR"
}

# Rewrite git repository history
install_git-filter-repo() {
	eget newren/git-filter-repo --file="*" --to=git-filter-repo

	cp git-filter-repo/git-filter-repo "$BINDIR/"
	cp -rv git-filter-repo/Documentation/man1 "$MANDIR/man1/"

	rm -rf git-filter-repo
}

# Database migration tool
install_goose() {
	eget pressly/goose --to="$BINDIR"
}

# Hetzner Cloud CLI
install_hcloud() {
	eget hetznercloud/cli -f hcloud --to="$BINDIR"
}

# Kubernetes package manager
install_helm() {
	curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-4 | HELM_INSTALL_DIR="$BINDIR" USE_SUDO="false" bash
}

# Procfile runner
install_hivemind() {
	eget DarthSim/hivemind --to="$BINDIR"
}

# JSON log viewer
install_hl() {
	eget pamburus/hl -a "$(musl_tag)" --to="$BINDIR"
}

# Jujutsu - git alternative
install_jj() {
	eget jj-vcs/jj --to="$BINDIR"

	eget jj-vcs/jj -a 'docs' -d --to=jj-docs.tar.gz
	mkdir -p ~/.local/share/doc/jj
	tar xf jj-docs.tar.gz -C ~/.local/share/doc/jj

	mkdir -p ~/.local/share/man
	jj util install-man-pages ~/.local/share/man
}

# Kubernetes cluster manager
install_k9s() {
	eget -a 'tar.gz' -a '^sbom' derailed/k9s --to="$BINDIR"
}

# simple deployment tool for k8s
install_kapp() {
	eget carvel-dev/kapp --to="$BINDIR"
}

# Image building and pushing for k8s
install_kbld() {
	eget carvel-dev/kbld --to="$BINDIR"
}

# Friendly interface to git
install_lazygit() {
	eget jesseduffield/lazygit --to="$BINDIR"
}

# Command-line access to LLMs
install_llm() {
	@get uv
	uv tool install llm --with llm-cmd-comp,llm-anthropic
}

# Framework-agnostic database migrations
install_migrate() {
	eget golang-migrate/migrate --to="$BINDIR"
}

# Ripgrep - modern grep alternative
install_rg() {
	eget BurntSushi/ripgrep --file="*" --to=ripgrep

	cp ripgrep/rg "$BINDIR/"
	cp ripgrep/doc/rg.1 "$MANDIR/man1/"
	cp ripgrep/complete/rg.fish "$HOME/.config/fish/completions/"

	rm -rf ripgrep
}

# Modern sed replacement
install_sd() {
	eget chmln/sd --file="*" --to=sd

	cp sd/sd "$BINDIR/"
	cp sd/sd.1 "$MANDIR/man1/"
	cp sd/completions/sd.fish "$HOME/.config/fish/completions/"

	rm -rf sd
}

# Shell GPT integration
install_sgpt() {
	eget -a '^.json' tbckr/sgpt --file="*" --all --to=sgpt

	cp sgpt/sgpt "$BINDIR/"
	cp sgpt/sgpt.1.gz "$MANDIR/man1/"
	cp sgpt/sgpt.fish "$HOME/.config/fish/completions/"

	rm -rf sgpt
}

# Python package installer
install_uv() {
	curl -LsSf https://astral.sh/uv/install.sh | UV_INSTALL_DIR="$BINDIR" INSTALLER_NO_MODIFY_PATH=1 sh
}

# CLI to manage Vultr resources
install_vultr-cli() {
	eget vultr/vultr-cli --to="$BINDIR"
}

# File monitor and command runner
install_watchexec() {
	eget -a "$(musl_tag)" -a '^b3' -a '^sha512' -a 'tar' watchexec/watchexec --file="*" --to=watchexec

	cp watchexec/watchexec "$BINDIR/"
	cp watchexec/watchexec.1 "$MANDIR/man1/"
	cp watchexec/completions/fish "$HOME/.config/fish/completions/watchexec.fish"

	rm -rf watchexec
}

# Friendly HTTP client
install_xh() {
	eget ducaale/xh --to="$BINDIR"
	eget ducaale/xh --file="*" --to=xh

	cp xh/xh "$BINDIR/"
	cp xh/doc/xh.1 "$MANDIR/man1/"
	cp xh/completions/xh.fish "$HOME/.config/fish/completions/"

	rm -rf xh
}

# YAML templating tool
install_ytt() {
	eget carvel-dev/ytt --to="$BINDIR"
}

# Smart directory jumper
install_zoxide() {
	eget ajeetdsouza/zoxide --file="*" --all --to=zoxide

	cp zoxide/zoxide "$BINDIR/"
	cp -r zoxide/man/* "$MANDIR/"
	cp zoxide/completions/zoxide.fish "$HOME/.config/fish/completions/"

	rm -rf zoxide
}

main() {
	cd "$TMPDIR"
	BINDIR="${argc_target:?}/bin"
	MANDIR="${argc_target:?}/share/man"
	mkdir -p "$BINDIR" "$MANDIR/man1" "$MANDIR/man5"

	for binary in "${argc_packages[@]}"; do
		if ! declare -F "install_$binary" >/dev/null; then
			echo "ERROR: Unknown binary: $binary" >&2
			return 1
		fi

		if [[ ! "${argc_force:-}" ]] && command -v "$binary" >/dev/null 2>&1; then
			echo "$binary: already installed (use --force to reinstall)"
			continue
		fi

		echo "Installing $binary..."
		(set -x; "install_$binary")
	done
}

# Check if this system is darwin.
is_darwin() {
	[[ $(uname -s) == "Darwin" ]]
}

# Check if this system is musl-based.
is_musl() {
	if command -v ldd >/dev/null && [[ $(ldd --version || true) != *GLIBC* ]]; then
		return 0
	else
		return 1
	fi
}

# If this system is musl-based, print "musl". Else print "^musl".
musl_tag() {
	if is_musl; then
		echo -n "musl"
	else
		echo -n "^musl"
	fi
}

if ! command -v argc >/dev/null; then
	echo "This command requires argc. Install from https://github.com/sigoden/argc" >&2
	exit 100
fi
eval "$(argc --argc-eval "$0" "$@")"
