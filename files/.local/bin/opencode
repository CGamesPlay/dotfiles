#!/usr/bin/env bash
# @describe Wrapper for opencode
#
# The wrapper is can auto-install opencode when needed.
# @version wrapper, use --opencode-version for version information
# @arg args~                Additional arguments, passed verbatim
# @flag --opencode-help       Show help for Opencode
# @flag --opencode-version    Show version for Opencode
# @flag --opencode-reinstall  Reinstall Opencode even if already installed

set -eu

main() {
	# shellcheck disable=1091
	set +u
	. "${NVM_DIR:?NVM_DIR is not set}/nvm.sh"
	nvm use --lts > /dev/null
	set -u

	if [[ "${argc_opencode_reinstall+1}" ]] || ! npm --no-update-notifier list -g opencode-ai >/dev/null; then
		echo "Opencode is not installed. Installing..." >&2
		npm --no-update-notifier install -g opencode-ai@latest
	fi
	exec opencode \
		${argc_opencode_help+--help} \
		${argc_opencode_version+--version} \
		${argc_args+"${argc_args[@]}"}
}

eval "$(argc --argc-eval "$0" "$@")"
