#!/usr/bin/env bash
# @describe Wrapper for Claude Code.
#
# The wrapper is responsible for setting up CLAUDE_CONFIG_DIR, and can
# auto-install claude when needed.
# @version wrapper, use --claude-version for version information
# @flag -c --continue       Continue the last conversation
# @flag --yolo              "Dangerously" skip "permisisons".
# @flag --skip-happy        Do not run via happy wrapper
# @flag --claude-help       Show help for Claude Code
# @flag --claude-version    Show version for Claude Code
# @flag --claude-reinstall  Reinstall Claude Code even if already installed
# @flag --claude-usage      Run ccusage instead of Claude Code.
# @arg args~                Additional arguments, passed verbatim

set -eu

# In the future, potentially look into integrating:
# - mobile: https://github.com/slopus/happy
#
# ALso, other things
# - web: https://github.com/All-Hands-AI/OpenHands
# - web: https://github.com/boldsoftware/sketch
# - nvim: https://github.com/olimorris/codecompanion.nvim
# - nvim: https://github.com/coder/claudecode.nvim

main() {
	set +u
	# shellcheck disable=1091
	. "${NVM_DIR:?NVM_DIR is not set}/nvm.sh"
	nvm use --lts > /dev/null
	set -u

	# Keep ~ clean
	export CLAUDE_CONFIG_DIR=~/.config/claude
	local bin=claude allow_yolo= yolo=

	if [[ "${argc_claude_usage+1}" ]]; then
		exec @iterm open https://claude.ai/settings/usage
	fi
	if [[ "${argc_claude_reinstall+1}" ]] || ! npm --no-update-notifier list -g @anthropic-ai/claude-code >/dev/null; then
		echo "Claude Code is not installed. Installing..." >&2
		npm --no-update-notifier install -g @anthropic-ai/claude-code@latest
	fi
	if [[ ! ${argc_skip_happy+1} ]]; then
		bin=happy
		if [[ "${argc_claude_reinstall+1}" ]] || ! npm --no-update-notifier list -g happy-coder >/dev/null; then
			echo "Happy is not installed. Installing..." >&2
			npm --no-update-notifier install -g happy-coder@latest
		fi
	fi

	if [[ ${ATRIUM_WORKSPACE+1} ]] || [[ ${CODER+1} ]]; then
		allow_yolo=1
	fi
	if [[ ${argc_yolo+1} ]]; then
		yolo=1
	fi

	# Workaround for https://github.com/anthropics/claude-code/issues/14485
	local marketplace_file="$CLAUDE_CONFIG_DIR/plugins/known_marketplaces.json"
	if [[ ! -f "$marketplace_file" ]]; then
		mkdir -p "$CLAUDE_CONFIG_DIR/plugins/marketplaces"
		local now
		now=$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")
		cat > "$marketplace_file" <<EOF
{
  "claude-plugins-official": {
    "source": {
      "source": "git",
      "url": "https://github.com/anthropics/claude-plugins-official.git"
    },
    "installLocation": "$HOME/.config/claude/plugins/marketplaces/claude-plugins-official",
    "lastUpdated": "$now"
  }
}
EOF
		git clone "https://github.com/anthropics/claude-plugins-official.git" "$CLAUDE_CONFIG_DIR/plugins/marketplaces/claude-plugins-official"
	else
		jq 'walk(if type == "object" and has("repo") then .source = "git" | .url = ("https://github.com/" + .repo + ".git") | del(.repo) else . end)' \
			"$marketplace_file" > "$marketplace_file.tmp" && mv "$marketplace_file.tmp" "$marketplace_file"
	fi

	exec "$bin" \
		${argc_claude_help+--help} \
		${argc_claude_version+--version} \
		${argc_continue:+--continue} \
		${argc_resume:+--resume "$argc_resume"} \
		${argc_args+"${argc_args[@]}"} \
		${allow_yolo:+--allow-dangerously-skip-permissions} \
		${yolo:+--dangerously-skip-permissions}
}

eval "$(argc --argc-eval "$0" "$@")"
